<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORTEX // Workflow Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #050508;
            --bg-secondary: #0a0a10;
            --bg-card: #0d0d14;
            --bg-elevated: #12121c;
            --border-dim: #1a1a28;
            --border-active: #2a2a3a;

            --accent-cyan: #40d8e8;
            --accent-cyan-dim: #2eb0c0;
            --accent-amber: #e8b840;
            --accent-amber-dim: #c89820;
            --accent-green: #40d888;
            --accent-green-dim: #28b868;
            --accent-pink: #e85080;
            --accent-pink-dim: #c83060;
            --accent-purple: #a890d8;

            --text-primary: #ffffff;
            --text-secondary: #d0d0dc;
            --text-dim: #9898a8;

            --glow-cyan: 0 0 20px rgba(64, 216, 232, 0.35);
            --glow-amber: 0 0 20px rgba(232, 184, 64, 0.35);
            --glow-green: 0 0 20px rgba(64, 216, 136, 0.35);
            --glow-pink: 0 0 20px rgba(232, 80, 128, 0.35);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Scan line overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 2px,
                rgba(0, 0, 0, 0.1) 4px
            );
            z-index: 9999;
        }

        /* Noise texture */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            z-index: 9998;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-dim);
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 200px;
            height: 1px;
            background: linear-gradient(90deg, var(--accent-cyan), transparent);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            border: 2px solid var(--accent-cyan);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .logo-icon::before {
            content: '';
            width: 20px;
            height: 20px;
            background: var(--accent-cyan);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            animation: pulse-diamond 2s infinite;
        }

        @keyframes pulse-diamond {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        .logo h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 4px;
            color: var(--text-primary);
        }

        .logo h1 span {
            color: var(--accent-cyan);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            box-shadow: var(--glow-green);
            animation: pulse-glow 1.5s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--accent-green); }
            50% { opacity: 0.5; box-shadow: 0 0 20px var(--accent-green); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-block {
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
        }

        .stat-block.active::before { background: var(--accent-amber); }
        .stat-block.queued::before { background: var(--accent-cyan); }
        .stat-block.completed::before { background: var(--accent-green); }
        .stat-block.failed::before { background: var(--accent-pink); }

        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
        }

        .stat-block.active .stat-value { color: var(--accent-amber); text-shadow: var(--glow-amber); }
        .stat-block.queued .stat-value { color: var(--accent-cyan); text-shadow: var(--glow-cyan); }
        .stat-block.completed .stat-value { color: var(--accent-green); text-shadow: var(--glow-green); }
        .stat-block.failed .stat-value { color: var(--accent-pink); text-shadow: var(--glow-pink); }

        .stat-delta {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 8px;
        }

        /* Links Bar */
        .links-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .link-btn {
            background: transparent;
            border: 1px solid var(--border-dim);
            color: var(--text-secondary);
            padding: 8px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .link-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            background: rgba(0, 240, 255, 0.05);
        }

        .config-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            padding-left: 20px;
            border-left: 1px solid var(--border-dim);
        }

        .config-group label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .config-input {
            width: 50px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-dim);
            color: var(--accent-cyan);
            padding: 6px 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            text-align: center;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .config-btn {
            background: var(--accent-cyan);
            border: none;
            color: var(--bg-primary);
            padding: 7px 14px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .config-btn:hover {
            box-shadow: var(--glow-cyan);
        }

        /* Search & Filters */
        .controls-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-dim);
            color: var(--text-primary);
            padding: 12px 16px;
            padding-left: 40px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .search-box::before {
            content: '>';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-cyan);
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: var(--text-dim);
        }

        .filter-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-dim);
            color: var(--text-primary);
            padding: 12px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            min-width: 140px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .result-count {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-dim);
        }

        .tab-btn {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            padding: 12px 24px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        .tab-btn .count {
            background: var(--bg-elevated);
            padding: 2px 8px;
            margin-left: 8px;
            font-size: 10px;
        }

        .tab-btn.active .count {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .tab-btn.failed-tools {
            color: var(--accent-pink);
        }

        .tab-btn.failed-tools.active {
            border-bottom-color: var(--accent-pink);
        }

        .tab-btn.failed-tools .count {
            background: var(--accent-pink);
            color: var(--bg-primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            max-height: calc(100vh - 420px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Custom scrollbar */
        .tab-content::-webkit-scrollbar {
            width: 6px;
        }

        .tab-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .tab-content::-webkit-scrollbar-thumb {
            background: var(--border-active);
        }

        .tab-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }

        /* Workflow Grid */
        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 15px;
        }

        /* Workflow Card */
        .workflow-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
            border: 1px solid var(--border-active);
            position: relative;
            overflow: hidden;
            transition: all 0.25s ease;
            border-radius: 4px;
        }

        .workflow-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .workflow-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .workflow-card.status-active::before { background: linear-gradient(90deg, var(--accent-amber), var(--accent-amber-dim)); box-shadow: var(--glow-amber); }
        .workflow-card.status-success::before { background: linear-gradient(90deg, var(--accent-green), var(--accent-green-dim)); }
        .workflow-card.status-failed::before { background: linear-gradient(90deg, var(--accent-pink), var(--accent-pink-dim)); box-shadow: var(--glow-pink); }
        .workflow-card.status-queued::before { background: linear-gradient(90deg, var(--accent-cyan), var(--accent-cyan-dim)); }

        .card-header {
            padding: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .card-header:hover {
            background: var(--bg-elevated);
        }

        .card-title-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .app-name-section {
            flex: 1;
        }

        .app-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--text-primary);
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.15);
            margin-bottom: 6px;
        }

        .run-count {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .run-count span {
            color: var(--accent-pink);
            font-weight: 700;
        }

        .status-badge {
            padding: 6px 14px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        .status-badge.active {
            background: var(--accent-amber);
            color: var(--bg-primary);
            box-shadow: var(--glow-amber);
        }

        .status-badge.success {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .status-badge.failed {
            background: var(--accent-pink);
            color: var(--bg-primary);
            box-shadow: var(--glow-pink);
        }

        .status-badge.queued {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 11px;
            color: var(--text-secondary);
            padding-top: 14px;
            border-top: 1px solid var(--border-dim);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-label {
            color: var(--text-dim);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-meta a {
            color: var(--accent-cyan);
            text-decoration: none;
            transition: all 0.2s;
            font-weight: 500;
        }

        .card-meta a:hover {
            text-shadow: var(--glow-cyan);
        }

        .card-meta .ua-link {
            color: var(--accent-pink);
            background: rgba(232, 80, 128, 0.15);
            padding: 3px 10px;
            font-weight: 600;
        }

        .card-meta .ua-link:hover {
            text-shadow: var(--glow-pink);
            background: rgba(232, 80, 128, 0.25);
        }

        .card-meta .pr-link {
            color: var(--accent-green);
            font-weight: 500;
        }

        .workflow-id {
            font-size: 10px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            opacity: 0.8;
        }

        /* Progress Section */
        .progress-section {
            padding: 12px 16px;
            border-top: 1px solid var(--border-dim);
            background: var(--bg-secondary);
        }

        .progress-bar-container {
            height: 4px;
            background: var(--border-dim);
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
            transition: width 0.3s;
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-20px); }
            100% { transform: translateX(20px); }
        }

        .progress-stats {
            display: flex;
            gap: 20px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-stats .passed { color: var(--accent-green); }
        .progress-stats .failed { color: var(--accent-pink); }
        .progress-stats .total { color: var(--text-dim); }

        /* Retry Section */
        .retry-section {
            padding: 12px 16px;
            border-top: 1px solid var(--border-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 0, 102, 0.03);
        }

        .retry-info {
            font-size: 11px;
            color: var(--accent-pink);
        }

        .retry-btn {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-pink-dim));
            border: none;
            color: white;
            padding: 10px 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .retry-btn:hover {
            box-shadow: var(--glow-pink);
            transform: translateY(-1px);
        }

        .retry-btn.rerun {
            background: linear-gradient(135deg, var(--accent-amber), var(--accent-amber-dim));
        }

        .retry-btn.rerun:hover {
            box-shadow: var(--glow-amber);
        }

        /* History Section */
        .history-section {
            display: none;
            padding: 12px 16px;
            border-top: 1px solid var(--border-dim);
            background: var(--bg-primary);
            max-height: 200px;
            overflow-y: auto;
        }

        .history-section.expanded {
            display: block;
        }

        .history-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 12px;
        }

        .history-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-dim);
            font-size: 10px;
        }

        .history-row:last-child {
            border-bottom: none;
        }

        .history-run {
            color: var(--text-secondary);
        }

        .history-badge {
            background: var(--accent-amber);
            color: var(--bg-primary);
            padding: 2px 6px;
            font-size: 8px;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .history-stats {
            color: var(--text-dim);
        }

        .history-date {
            color: var(--text-dim);
        }

        .history-link {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        .history-link:hover {
            text-shadow: var(--glow-cyan);
        }

        /* Empty State */
        .empty-state {
            padding: 60px;
            text-align: center;
            color: var(--text-dim);
            background: var(--bg-card);
            border: 1px dashed var(--border-dim);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
        }

        .pagination-btn {
            background: transparent;
            border: 1px solid var(--border-dim);
            color: var(--text-secondary);
            padding: 10px 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pagination-info span {
            color: var(--accent-cyan);
        }

        /* Failed Tools Section */
        .failed-tools-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            border-left: 3px solid var(--accent-pink);
        }

        .ft-stats {
            display: flex;
            gap: 30px;
        }

        .ft-stat {
            text-align: center;
        }

        .ft-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 600;
        }

        .ft-stat-value.pending { color: var(--accent-amber); }
        .ft-stat-value.retrying { color: var(--accent-cyan); }
        .ft-stat-value.fixed { color: var(--accent-green); }

        .ft-stat-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .ft-filters {
            display: flex;
            gap: 10px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
        }

        .modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-amber));
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 2px;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--accent-pink);
        }

        .modal-body {
            padding: 20px;
            max-height: 55vh;
            overflow-y: auto;
        }

        .modal-config {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-dim);
        }

        .modal-config label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            white-space: nowrap;
            min-width: 100px;
        }

        .modal-input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-dim);
            color: var(--text-primary);
            padding: 10px 14px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .modal-select {
            background: var(--bg-primary);
            border: 1px solid var(--border-dim);
            color: var(--text-primary);
            padding: 10px 14px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            cursor: pointer;
        }

        .modal-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .actions-editor {
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-dim);
        }

        .actions-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .actions-editor-header label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .actions-count {
            font-size: 10px;
            color: var(--accent-cyan);
        }

        .actions-list {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid var(--border-dim);
            background: var(--bg-primary);
        }

        .action-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-dim);
            font-size: 11px;
        }

        .action-item:last-child {
            border-bottom: none;
        }

        .action-item:hover {
            background: var(--bg-secondary);
        }

        .action-name {
            color: var(--text-secondary);
            word-break: break-all;
        }

        .action-remove {
            background: var(--accent-pink);
            color: white;
            border: none;
            padding: 4px 10px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-remove:hover {
            box-shadow: var(--glow-pink);
        }

        .script-output {
            background: var(--bg-primary);
            border: 1px solid var(--border-dim);
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--accent-green);
            max-height: 250px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-dim);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .modal-btn.primary {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .modal-btn.primary:hover {
            box-shadow: var(--glow-green);
        }

        .modal-btn.secondary {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-dim);
        }

        .modal-btn.secondary:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-dim);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-dim);
            border-top-color: var(--accent-cyan);
            border-radius: 0;
            animation: spin 0.8s linear infinite;
            margin-left: 15px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Grid background effect */
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background-image:
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .workflow-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .links-bar {
                justify-content: center;
            }

            .config-group {
                margin-left: 0;
                padding-left: 0;
                border-left: none;
                padding-top: 15px;
                border-top: 1px solid var(--border-dim);
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon"></div>
                <h1><span>CORTEX</span> // COMMAND</h1>
            </div>
            <div class="header-status">
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>LIVE</span>
                </div>
                <span>REFRESH: 10S</span>
                <span id="lastUpdated">SYNCING...</span>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-block active">
                <div class="stat-label">Active Workflows</div>
                <div class="stat-value" id="activeCount">-</div>
                <div class="stat-delta">Currently executing</div>
            </div>
            <div class="stat-block queued">
                <div class="stat-label">Pending Queue</div>
                <div class="stat-value" id="pendingCount">-</div>
                <div class="stat-delta">Awaiting execution</div>
            </div>
            <div class="stat-block completed">
                <div class="stat-label">Completed</div>
                <div class="stat-value" id="completedCount">-</div>
                <div class="stat-delta">Total processed</div>
            </div>
            <div class="stat-block failed">
                <div class="stat-label">Failed Tools</div>
                <div class="stat-value" id="failedToolsCount">-</div>
                <div class="stat-delta">Require attention</div>
            </div>
        </div>

        <div class="links-bar">
            <a href="https://linear.app/composio/team/PAR/active" target="_blank" class="link-btn">Linear Board</a>
            <a href="https://github.com/ComposioHQ/composio/pulls?q=is%3Apr+is%3Aopen+cortex%2Ffix" target="_blank" class="link-btn">Open PRs</a>
            <a href="https://docs.google.com/spreadsheets/d/1SxDwzMqpS8y-5we-kvzcaTDvWwHacU5QbPT0FIvTM9U/edit?gid=847538700" target="_blank" class="link-btn">Connections</a>
            <a href="https://integrations-api.composio.io/docs" target="_blank" class="link-btn">API Docs</a>
            <div class="config-group">
                <label>Max Concurrent:</label>
                <input type="number" class="config-input" id="maxConcurrent" value="12" min="1" max="20">
                <button class="config-btn" onclick="updateMaxConcurrent()">Set</button>
            </div>
        </div>

        <div class="controls-bar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search workflows... (Press / to focus)" oninput="applyFilters()">
            </div>
            <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                <option value="all">All Status</option>
                <option value="success">Success</option>
                <option value="failed">Failed</option>
                <option value="auth_issue">Auth Issues</option>
                <option value="has_failures">Has Failures</option>
                <option value="perfect">100% Pass</option>
            </select>
            <select class="filter-select" id="sortFilter" onchange="applyFilters()">
                <option value="time_desc" selected>Most Recent</option>
                <option value="time_asc">Oldest First</option>
                <option value="passed_desc">Most Passed</option>
                <option value="passed_asc">Least Passed</option>
                <option value="rate_desc">Best Rate</option>
                <option value="rate_asc">Worst Rate</option>
            </select>
            <span class="result-count" id="searchCount"></span>
        </div>

        <div class="tabs-container">
            <button class="tab-btn active" data-tab="active" onclick="showTab('active')">Active<span class="count" id="activeTabCount">0</span></button>
            <button class="tab-btn" data-tab="pending" onclick="showTab('pending')">Pending<span class="count" id="pendingTabCount">0</span></button>
            <button class="tab-btn" data-tab="completed" onclick="showTab('completed')">Completed<span class="count" id="completedTabCount">0</span></button>
            <button class="tab-btn failed-tools" data-tab="failedTools" onclick="showTab('failedTools')">Failed Tools<span class="count" id="failedToolsTabCount">0</span></button>
        </div>

        <div id="active" class="tab-content active">
            <div class="workflow-grid" id="activeGrid">
                <div class="loading">Initializing</div>
            </div>
        </div>

        <div id="pending" class="tab-content">
            <div class="workflow-grid" id="pendingGrid">
                <div class="loading">Initializing</div>
            </div>
        </div>

        <div id="completed" class="tab-content">
            <div class="workflow-grid" id="completedGrid">
                <div class="loading">Initializing</div>
            </div>
            <div class="pagination" id="completedPagination">
                <button class="pagination-btn" onclick="changePage(-1)" id="prevPageBtn" disabled>&#x276E; Prev</button>
                <span class="pagination-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                <button class="pagination-btn" onclick="changePage(1)" id="nextPageBtn" disabled>Next &#x276F;</button>
            </div>
        </div>

        <div id="failedTools" class="tab-content">
            <div class="failed-tools-header">
                <div class="ft-stats">
                    <div class="ft-stat">
                        <div class="ft-stat-value pending" id="ftPendingCount">0</div>
                        <div class="ft-stat-label">Pending</div>
                    </div>
                    <div class="ft-stat">
                        <div class="ft-stat-value retrying" id="ftRetryingCount">0</div>
                        <div class="ft-stat-label">Retrying</div>
                    </div>
                    <div class="ft-stat">
                        <div class="ft-stat-value fixed" id="ftCompletedCount">0</div>
                        <div class="ft-stat-label">Fixed</div>
                    </div>
                </div>
                <div class="ft-filters">
                    <input type="text" class="filter-select" id="ftSearchInput" placeholder="Search toolkits..." oninput="filterFailedTools()" style="min-width: 180px;">
                    <select class="filter-select" id="ftStatusFilter" onchange="filterFailedTools()">
                        <option value="all">All Toolkits</option>
                        <option value="pending">Has Pending</option>
                        <option value="active">Active</option>
                        <option value="retrying">Retrying</option>
                    </select>
                </div>
            </div>
            <div class="workflow-grid" id="failedToolsGrid">
                <div class="loading">Initializing</div>
            </div>
            <div class="pagination" id="failedToolsPagination" style="display: none;">
                <button class="pagination-btn" onclick="changeFailedToolsPage(-1)" id="ftPrevBtn">&#x276E; Prev</button>
                <span class="pagination-info">Page <span id="ftCurrentPage">1</span> of <span id="ftTotalPages">1</span></span>
                <button class="pagination-btn" onclick="changeFailedToolsPage(1)" id="ftNextBtn">Next &#x276F;</button>
            </div>
        </div>
    </div>

    <!-- Retry Modal -->
    <div id="retryModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>RETRY: <span id="modalAppName"></span></h2>
                <button class="modal-close" onclick="closeRetryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-config">
                    <label>App Name:</label>
                    <input type="text" id="appNameInput" class="modal-input" placeholder="e.g. agent_mail" onchange="updateRetryAppName(this.value)">
                </div>
                <div class="modal-config">
                    <label>Connection ID:</label>
                    <input type="text" id="connectionIdInput" class="modal-input" placeholder="ca_xxxxx" onchange="updateRetryConnectionId(this.value)">
                </div>
                <div class="modal-config">
                    <label>Linear Ticket:</label>
                    <input type="text" id="linearTicketInput" class="modal-input" placeholder="PAR-1234" onchange="updateRetryLinearTicket(this.value)">
                </div>
                <div class="modal-config">
                    <label>Environment:</label>
                    <select id="environmentSelect" class="modal-select" onchange="updateRetryEnvironment(this.value)">
                        <option value="production">Production</option>
                        <option value="staging">Staging</option>
                    </select>
                </div>
                <div id="actionsEditor" class="actions-editor" style="display: none;">
                    <div class="actions-editor-header">
                        <label>Actions to Retry:</label>
                        <span id="actionsCount" class="actions-count"></span>
                    </div>
                    <div id="actionsList" class="actions-list"></div>
                </div>
                <div id="scriptOutput" class="script-output"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeRetryModal()">Cancel</button>
                <button class="modal-btn secondary" onclick="copyScript()">Copy</button>
                <button id="executeBtn" class="modal-btn primary" onclick="executeRetry()">Execute</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        let SUPABASE_URL = null;
        let SUPABASE_ANON_KEY = null;
        const INTEGRATOR_API_URL = 'https://integrations-api.composio.io';

        let supabaseClient = null;
        let currentTab = window.location.hash.replace('#', '') || 'active';
        let currentRetryData = {};
        let allWorkflows = { active: [], completed: [], pending: [] };

        const ITEMS_PER_PAGE = 50;
        let currentPage = 1;
        let totalPages = 1;

        let allFailedTools = [];
        let filteredFailedTools = [];
        let ftCurrentPage = 1;
        let ftTotalPages = 1;
        let ftActiveWorkflows = {};

        function formatTime(ts) {
            if (!ts) return 'N/A';
            try {
                const dt = new Date(ts);
                return dt.toISOString().slice(0, 16).replace('T', ' ');
            } catch {
                return ts.slice(0, 16);
            }
        }

        async function fetchData() {
            try {
                let allRuns = [];
                let offset = 0;
                const batchSize = 1000;

                while (true) {
                    const { data: batch, error: batchError } = await supabaseClient
                        .from('workflow_runs')
                        .select('*, workflows(app_name, linear_ticket, connection_id, environment)')
                        .order('started_at', { ascending: false })
                        .range(offset, offset + batchSize - 1);

                    if (batchError) throw batchError;
                    if (!batch || batch.length === 0) break;

                    allRuns = allRuns.concat(batch);
                    if (batch.length < batchSize) break;
                    offset += batchSize;
                }

                const runs = allRuns;

                const { data: queue, error: queueError } = await supabaseClient
                    .from('queued_workflows')
                    .select('*')
                    .order('position', { ascending: true });

                if (queueError) throw queueError;

                const { data: config } = await supabaseClient
                    .from('config')
                    .select('*')
                    .eq('key', 'max_concurrent')
                    .single();

                if (config) {
                    document.getElementById('maxConcurrent').value = config.value || 12;
                }

                const workflows = {};
                for (const run of runs || []) {
                    const wfId = run.workflow_id;
                    if (!workflows[wfId]) workflows[wfId] = [];
                    workflows[wfId].push(run);
                }

                const active = [];
                const completed = [];

                for (const [wfId, wfRuns] of Object.entries(workflows)) {
                    const sortedRuns = wfRuns.sort((a, b) => (a.run_number || 0) - (b.run_number || 0));
                    const latestRun = sortedRuns[sortedRuns.length - 1];
                    const firstRun = sortedRuns[0];
                    const hasActive = wfRuns.some(r => r.status === 'active');

                    const firstRunTotal = firstRun.total || 0;
                    let aggregationStartIndex = 0;

                    for (let i = sortedRuns.length - 1; i > 0; i--) {
                        const run = sortedRuns[i];
                        if (run.total === firstRunTotal && run.status === 'completed') {
                            aggregationStartIndex = i;
                            break;
                        }
                    }

                    const runsToAggregate = sortedRuns.slice(aggregationStartIndex);
                    const aggregatedPassed = runsToAggregate
                        .filter(r => r.status === 'completed')
                        .reduce((sum, r) => sum + (r.passed || 0), 0);
                    const total = firstRunTotal;

                    const workflow = {
                        workflow_id: wfId,
                        workflows: latestRun.workflows || {},
                        run_number: latestRun.run_number || 1,
                        runs: sortedRuns,
                        passed: aggregatedPassed,
                        total: total,
                        failed_actions: latestRun.failed_actions || [],
                        execution_state: latestRun.execution_state || 'PENDING',
                        pr_number: latestRun.pr_number,
                        pr_state: latestRun.pr_state || '',
                        started_at: firstRun.started_at,
                        completed_at: latestRun.completed_at,
                        status: hasActive ? 'active' : 'completed'
                    };

                    if (hasActive) {
                        active.push(workflow);
                    } else {
                        completed.push(workflow);
                    }
                }

                active.sort((a, b) => (a.started_at || '').localeCompare(b.started_at || ''));
                completed.sort((a, b) => (b.completed_at || '').localeCompare(a.completed_at || ''));

                allWorkflows = { active, completed, pending: queue || [] };

                document.getElementById('activeCount').textContent = active.length;
                document.getElementById('pendingCount').textContent = queue?.length || 0;
                document.getElementById('completedCount').textContent = completed.length;
                document.getElementById('activeTabCount').textContent = active.length;
                document.getElementById('pendingTabCount').textContent = queue?.length || 0;
                document.getElementById('completedTabCount').textContent = completed.length;
                document.getElementById('lastUpdated').textContent = new Date().toISOString().slice(0, 19).replace('T', ' ') + ' UTC';

                renderCards();

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function getStatusClass(workflow, isActive) {
            if (isActive) return 'active';
            const failureStates = ['FAILED', 'FAILED_AUTH_ISSUE', 'INFRA_EXECUTION_FAILED', 'INFRA_INITIATION_FAILED', 'TIMED_OUT', 'ABORTED'];
            const state = (workflow.execution_state || '').toUpperCase();
            if (failureStates.includes(state)) return 'failed';
            const failedCount = Math.max(0, (workflow.total || 0) - (workflow.passed || 0));
            if (failedCount > 0) return 'failed';
            return 'success';
        }

        function generateWorkflowCard(workflow, isActive) {
            const wf = workflow.workflows || {};
            const appName = wf.app_name || 'unknown';
            const linearTicket = wf.linear_ticket || '';
            const workflowId = workflow.workflow_id || '';
            const connectionId = wf.connection_id || '';
            const environment = wf.environment || 'production';

            const passed = workflow.passed || 0;
            const total = workflow.total || 0;
            const failedCount = Math.max(0, total - passed);
            const executionState = workflow.execution_state || 'PENDING';
            const prNumber = workflow.pr_number;
            const prState = workflow.pr_state || '';
            const runNumber = workflow.run_number || 1;
            const started = formatTime(workflow.started_at);
            const runs = workflow.runs || [];
            const completedAt = workflow.completed_at || workflow.started_at || '';

            const statusClass = getStatusClass(workflow, isActive);
            const failureStates = ['FAILED', 'FAILED_AUTH_ISSUE', 'INFRA_EXECUTION_FAILED', 'INFRA_INITIATION_FAILED', 'TIMED_OUT', 'ABORTED'];

            let statusText;
            if (isActive) {
                statusText = executionState;
            } else if (failureStates.includes(executionState.toUpperCase())) {
                statusText = executionState;
            } else if (failedCount > 0) {
                statusText = `${failedCount} FAILED`;
            } else {
                statusText = 'SUCCESS';
            }

            const progress = total > 0 ? (passed / total * 100) : 0;

            const ticketHtml = linearTicket && linearTicket !== 'N/A'
                ? `<a href="https://linear.app/composio/issue/${linearTicket}" target="_blank">[${linearTicket}]</a>`
                : '';

            const prHtml = prNumber
                ? `<a href="https://github.com/ComposioHQ/composio/pull/${prNumber}" target="_blank" class="pr-link">PR #${prNumber}</a> <span style="color:var(--text-dim)">(${prState})</span>`
                : '';

            const logsLink = workflowId
                ? `<a href="https://usefulagents.com/workflows/${workflowId}?run=${runNumber}" target="_blank" class="ua-link">LOGS</a>`
                : '';

            const retryHtml = !isActive
                ? `<div class="retry-section">
                    ${failedCount > 0 ? `<span class="retry-info">${failedCount} failed actions</span>` : '<span></span>'}
                    <div style="display:flex;gap:8px;">
                        ${failedCount > 0 ? `<button class="retry-btn" onclick="showRetryModal('${appName}', '${workflowId}', '${linearTicket}', '${connectionId}', '${environment}', ${runNumber}, false)">Retry Failed</button>` : ''}
                        <button class="retry-btn rerun" onclick="showRetryModal('${appName}', '${workflowId}', '${linearTicket}', '${connectionId}', '${environment}', ${runNumber}, true)">Full Rerun</button>
                    </div>
                </div>`
                : '';

            let historyHtml = '';
            if (runs.length > 1) {
                const historyRows = runs
                    .sort((a, b) => (b.run_number || 0) - (a.run_number || 0))
                    .map(r => {
                        const rNum = r.run_number || 1;
                        const rPassed = r.passed || 0;
                        const rTotal = r.total || 0;
                        const rDate = formatTime(r.started_at);
                        const retryBadge = rNum > 1 ? '<span class="history-badge">RETRY</span>' : '';
                        return `<div class="history-row">
                            <span class="history-run">Run ${rNum}${retryBadge}</span>
                            <span class="history-stats">${rPassed}/${rTotal}</span>
                            <span class="history-date">${rDate}</span>
                            <a href="https://usefulagents.com/workflows/${workflowId}?run=${rNum}" target="_blank" class="history-link">View</a>
                        </div>`;
                    }).join('');

                historyHtml = `<div class="history-section" id="history-${workflowId}">
                    <div class="history-title">Run History (${runs.length})</div>
                    ${historyRows}
                </div>`;
            }

            return `<div class="workflow-card status-${statusClass}" data-completed="${completedAt}" data-passed="${passed}" data-total="${total}" data-app="${appName.toLowerCase()}" data-workflow="${workflowId.toLowerCase()}" data-ticket="${linearTicket.toLowerCase()}" data-state="${executionState.toLowerCase()}" data-failed="${failedCount}">
                <div class="card-header" onclick="toggleHistory('${workflowId}')">
                    <div class="card-title-row">
                        <div class="app-name-section">
                            <div class="app-name">${appName.toUpperCase()}</div>
                            <div class="run-count"><span>${failedCount}</span> FAILED  ${runs.length} runs</div>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="card-meta">
                        ${ticketHtml}
                        <span class="workflow-id">${workflowId}</span>
                        <span class="meta-item"><span class="meta-label">Run</span> #${runNumber}</span>
                        <span class="meta-item">${started}</span>
                        ${prHtml}
                    </div>
                </div>
                <div class="progress-section">
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width:${progress.toFixed(1)}%"></div>
                    </div>
                    <div class="progress-stats">
                        <span class="passed">${passed} PASSED</span>
                        <span class="failed">${failedCount} FAILED</span>
                        <span class="total">/ ${total} TOTAL</span>
                    </div>
                </div>
                ${retryHtml}
                ${historyHtml}
            </div>`;
        }

        function generatePendingCard(item) {
            const appName = item.app_name || 'unknown';
            const position = item.position || 0;
            const payload = item.payload || {};
            const env = payload.env || 'production';
            const actionNames = payload.action_names || [];
            const actionInfo = actionNames.length > 0 ? `${actionNames.length} actions` : 'all actions';

            return `<div class="workflow-card status-queued" data-app="${appName.toLowerCase()}">
                <div class="card-header">
                    <div class="card-title-row">
                        <div class="app-name-section">
                            <div class="app-name">${appName.toUpperCase()}</div>
                            <div class="run-count">Queued for testing</div>
                        </div>
                        <span class="status-badge queued">QUEUE #${position}</span>
                    </div>
                    <div class="card-meta">
                        <span class="meta-item"><span class="meta-label">Env</span> ${env}</span>
                        <span class="meta-item"><span class="meta-label">Testing</span> ${actionInfo}</span>
                    </div>
                </div>
            </div>`;
        }

        function getFilteredWorkflows(workflows) {
            const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            let filtered = workflows.filter(workflow => {
                const wf = workflow.workflows || {};
                const appName = (wf.app_name || '').toLowerCase();
                const workflowId = (workflow.workflow_id || '').toLowerCase();
                const ticket = (wf.linear_ticket || '').toLowerCase();
                const state = (workflow.execution_state || '').toLowerCase();
                const passed = workflow.passed || 0;
                const total = workflow.total || 0;
                const failed = Math.max(0, total - passed);

                const matchesSearch = searchTerm === '' ||
                    appName.includes(searchTerm) ||
                    workflowId.includes(searchTerm) ||
                    ticket.includes(searchTerm);

                let matchesStatus = true;
                if (statusFilter === 'success') {
                    matchesStatus = state.includes('success') || (total > 0 && passed === total && failed === 0);
                } else if (statusFilter === 'failed') {
                    matchesStatus = state.includes('failed') || state.includes('timed_out') || state.includes('aborted');
                } else if (statusFilter === 'auth_issue') {
                    matchesStatus = state.includes('auth');
                } else if (statusFilter === 'has_failures') {
                    matchesStatus = failed > 0;
                } else if (statusFilter === 'perfect') {
                    matchesStatus = total > 0 && passed === total;
                }

                return matchesSearch && matchesStatus;
            });

            filtered.sort((a, b) => {
                const aTime = a.completed_at || a.started_at || '';
                const bTime = b.completed_at || b.started_at || '';

                switch (sortFilter) {
                    case 'time_desc': return bTime.localeCompare(aTime);
                    case 'time_asc': return aTime.localeCompare(bTime);
                    case 'passed_desc': return (b.passed || 0) - (a.passed || 0);
                    case 'passed_asc': return (a.passed || 0) - (b.passed || 0);
                    case 'rate_desc':
                        const aRate = a.total > 0 ? a.passed / a.total : 0;
                        const bRate = b.total > 0 ? b.passed / b.total : 0;
                        return bRate - aRate;
                    case 'rate_asc':
                        const aRate2 = a.total > 0 ? a.passed / a.total : 0;
                        const bRate2 = b.total > 0 ? b.passed / b.total : 0;
                        return aRate2 - bRate2;
                    default: return 0;
                }
            });

            return filtered;
        }

        function renderCards() {
            const activeGrid = document.getElementById('activeGrid');
            const completedGrid = document.getElementById('completedGrid');
            const pendingGrid = document.getElementById('pendingGrid');

            if (allWorkflows.active.length > 0) {
                activeGrid.innerHTML = allWorkflows.active.map(w => generateWorkflowCard(w, true)).join('');
            } else {
                activeGrid.innerHTML = '<div class="empty-state">No active workflows</div>';
            }

            if (allWorkflows.completed.length > 0) {
                const filteredCompleted = getFilteredWorkflows(allWorkflows.completed);

                totalPages = Math.ceil(filteredCompleted.length / ITEMS_PER_PAGE);
                if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
                if (currentPage < 1) currentPage = 1;

                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredCompleted.length);
                const paginatedCompleted = filteredCompleted.slice(startIndex, endIndex);

                if (filteredCompleted.length > 0) {
                    completedGrid.innerHTML = paginatedCompleted.map(w => generateWorkflowCard(w, false)).join('');
                } else {
                    completedGrid.innerHTML = '<div class="empty-state">No matching workflows</div>';
                }

                document.getElementById('currentPage').textContent = currentPage;
                document.getElementById('totalPages').textContent = totalPages;
                document.getElementById('prevPageBtn').disabled = currentPage <= 1;
                document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
                document.getElementById('completedPagination').style.display = totalPages > 1 ? 'flex' : 'none';

                const searchTerm = document.getElementById('searchInput').value.trim();
                const statusFilter = document.getElementById('statusFilter').value;
                const countSpan = document.getElementById('searchCount');
                if (searchTerm || statusFilter !== 'all') {
                    countSpan.textContent = `${filteredCompleted.length} / ${allWorkflows.completed.length}`;
                } else {
                    countSpan.textContent = '';
                }
            } else {
                completedGrid.innerHTML = '<div class="empty-state">No completed workflows</div>';
                document.getElementById('completedPagination').style.display = 'none';
            }

            if (allWorkflows.pending.length > 0) {
                pendingGrid.innerHTML = allWorkflows.pending.map(p => generatePendingCard(p)).join('');
            } else {
                pendingGrid.innerHTML = '<div class="empty-state">Queue is empty</div>';
            }

            if (currentTab !== 'completed') {
                applyFiltersForActiveTab();
            }
        }

        // Failed Tools Functions
        async function fetchFailedTools() {
            try {
                const { data: tools, error } = await supabaseClient
                    .from('failed_tools')
                    .select('*')
                    .order('toolkit', { ascending: true });

                if (error) throw error;

                const { data: activeRuns } = await supabaseClient
                    .from('workflow_runs')
                    .select('*, workflows(app_name, linear_ticket, connection_id)')
                    .eq('status', 'active');

                ftActiveWorkflows = {};
                for (const run of activeRuns || []) {
                    const appName = run.workflows?.app_name;
                    if (appName) {
                        if (!ftActiveWorkflows[appName]) ftActiveWorkflows[appName] = [];
                        ftActiveWorkflows[appName].push(run);
                    }
                }

                const byToolkit = {};
                for (const t of tools || []) {
                    if (!byToolkit[t.toolkit]) {
                        byToolkit[t.toolkit] = {
                            toolkit: t.toolkit,
                            connection_id: t.connection_id,
                            linear_ticket: t.linear_ticket,
                            actions: [],
                            pending: 0,
                            retrying: 0,
                            completed: 0,
                            skipped: 0,
                            activeWorkflow: ftActiveWorkflows[t.toolkit]?.[0] || null
                        };
                    }
                    byToolkit[t.toolkit].actions.push(t);
                    byToolkit[t.toolkit][t.status]++;
                }

                allFailedTools = Object.values(byToolkit).sort((a, b) => b.pending - a.pending);

                let totalPending = 0, totalRetrying = 0, totalCompleted = 0;
                for (const tk of allFailedTools) {
                    totalPending += tk.pending;
                    totalRetrying += tk.retrying;
                    totalCompleted += tk.completed;
                }

                document.getElementById('failedToolsTabCount').textContent = allFailedTools.length;
                document.getElementById('failedToolsCount').textContent = totalPending;
                document.getElementById('ftPendingCount').textContent = totalPending;
                document.getElementById('ftRetryingCount').textContent = totalRetrying;
                document.getElementById('ftCompletedCount').textContent = totalCompleted;

                filterFailedTools();
            } catch (error) {
                console.error('Error fetching failed tools:', error);
                document.getElementById('failedToolsGrid').innerHTML = '<div class="empty-state">Error loading failed tools</div>';
            }
        }

        function filterFailedTools() {
            const search = document.getElementById('ftSearchInput')?.value?.toLowerCase() || '';
            const status = document.getElementById('ftStatusFilter')?.value || 'all';

            filteredFailedTools = allFailedTools.filter(tk => {
                if (search && !tk.toolkit.toLowerCase().includes(search)) return false;
                if (status === 'pending' && tk.pending === 0) return false;
                if (status === 'retrying' && tk.retrying === 0) return false;
                if (status === 'active' && !tk.activeWorkflow) return false;
                return true;
            });

            ftCurrentPage = 1;
            renderFailedTools();
        }

        function renderFailedTools() {
            const grid = document.getElementById('failedToolsGrid');
            ftTotalPages = Math.ceil(filteredFailedTools.length / ITEMS_PER_PAGE);

            const start = (ftCurrentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageTools = filteredFailedTools.slice(start, end);

            if (pageTools.length === 0) {
                grid.innerHTML = '<div class="empty-state">No failed tools found</div>';
                document.getElementById('failedToolsPagination').style.display = 'none';
                return;
            }

            grid.innerHTML = pageTools.map(tk => generateFailedToolCard(tk)).join('');

            const pagination = document.getElementById('failedToolsPagination');
            pagination.style.display = ftTotalPages > 1 ? 'flex' : 'none';
            document.getElementById('ftCurrentPage').textContent = ftCurrentPage;
            document.getElementById('ftTotalPages').textContent = ftTotalPages;
            document.getElementById('ftPrevBtn').disabled = ftCurrentPage <= 1;
            document.getElementById('ftNextBtn').disabled = ftCurrentPage >= ftTotalPages;
        }

        function generateFailedToolCard(tk) {
            const hasConnection = !!tk.connection_id;
            const totalActions = tk.actions.length;
            const completedCount = tk.completed;
            const pendingCount = tk.pending;
            const retryingCount = tk.retrying;
            const progress = totalActions > 0 ? (completedCount / totalActions * 100) : 0;

            const activeWf = tk.activeWorkflow;
            const isActive = !!activeWf;

            let statusClass, statusText;
            if (isActive) {
                statusClass = 'active';
                statusText = activeWf.execution_state || 'RUNNING';
            } else if (pendingCount === 0 && completedCount === totalActions) {
                statusClass = 'success';
                statusText = 'ALL FIXED';
            } else if (pendingCount > 0) {
                statusClass = 'failed';
                statusText = `${pendingCount} PENDING`;
            } else {
                statusClass = 'queued';
                statusText = 'SKIPPED';
            }

            const ticketHtml = tk.linear_ticket && tk.linear_ticket !== 'N/A'
                ? `<a href="https://linear.app/composio/issue/${tk.linear_ticket}" target="_blank">[${tk.linear_ticket}]</a>`
                : '';

            const activeLink = isActive
                ? `<a href="https://usefulagents.com/workflows/${activeWf.workflow_id}?run=${activeWf.run_number}" target="_blank" class="ua-link">ACTIVE RUN</a>`
                : '';

            const actionsHtml = tk.actions.map(a => {
                const statusColor = {
                    'pending': 'var(--accent-amber)',
                    'retrying': 'var(--accent-cyan)',
                    'completed': 'var(--accent-green)',
                    'skipped': 'var(--text-dim)'
                }[a.status] || 'var(--text-dim)';
                const reasonPreview = a.llm_reason ? a.llm_reason.substring(0, 80) + '...' : '';
                return `
                    <div class="action-item" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <span class="action-name">${a.action_name}</span>
                            <span style="color: ${statusColor}; font-size: 9px; padding: 2px 8px; background: rgba(255,255,255,0.05);">${a.status.toUpperCase()}</span>
                        </div>
                        ${reasonPreview ? `<div style="font-size: 9px; color: var(--text-dim); font-style: italic;">${reasonPreview}</div>` : ''}
                    </div>
                `;
            }).join('');

            return `
                <div class="workflow-card status-${statusClass}">
                    <div class="card-header" onclick="toggleFailedToolActions('${tk.toolkit}')">
                        <div class="card-title-row">
                            <div class="app-name-section">
                                <div class="app-name">${tk.toolkit.toUpperCase()}</div>
                                <div class="run-count"><span>${pendingCount}</span> PENDING  ${totalActions} actions</div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="card-meta">
                            ${ticketHtml}
                            ${activeLink}
                        </div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                        </div>
                        <div class="progress-stats">
                            <span class="passed">${completedCount} FIXED</span>
                            <span class="failed">${pendingCount} PENDING</span>
                            ${retryingCount > 0 ? `<span style="color: var(--accent-cyan);">${retryingCount} RETRYING</span>` : ''}
                            <span class="total">/ ${totalActions} TOTAL</span>
                        </div>
                    </div>
                    <div id="ft-actions-${tk.toolkit}" class="history-section" style="max-height: 250px;">
                        ${actionsHtml}
                    </div>
                    ${hasConnection && pendingCount > 0 && !isActive ? `
                        <div class="retry-section">
                            <span class="retry-info">${pendingCount} actions need retry</span>
                            <button class="retry-btn" onclick="showFailedToolsRetryModal('${tk.toolkit}')">Retry Failed</button>
                        </div>
                    ` : ''}
                    ${!hasConnection ? `
                        <div style="padding: 12px 16px; border-top: 1px solid var(--border-dim); color: var(--accent-pink); font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">
                            No connection available
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function toggleFailedToolActions(toolkit) {
            const el = document.getElementById(`ft-actions-${toolkit}`);
            if (el) {
                el.classList.toggle('expanded');
            }
        }

        function changeFailedToolsPage(delta) {
            ftCurrentPage = Math.max(1, Math.min(ftTotalPages, ftCurrentPage + delta));
            renderFailedTools();
        }

        function showFailedToolsRetryModal(toolkit) {
            const tk = allFailedTools.find(t => t.toolkit === toolkit);
            if (!tk) return;

            const pendingActions = tk.actions
                .filter(a => a.status === 'pending')
                .map(a => a.action_name);

            if (pendingActions.length === 0) {
                alert('No pending actions to retry');
                return;
            }

            currentRetryData = {
                app_name: tk.toolkit,
                workflow_id: `ft_${tk.toolkit}_${Date.now()}`,
                connection_id: tk.connection_id,
                linear_ticket: tk.linear_ticket || '',
                environment: 'production',
                failed_actions: [...pendingActions],
                isFailedTools: true
            };

            document.getElementById('modalAppName').textContent = tk.toolkit.toUpperCase();
            document.getElementById('appNameInput').value = tk.toolkit;
            document.getElementById('connectionIdInput').value = tk.connection_id || '';
            document.getElementById('linearTicketInput').value = tk.linear_ticket || '';
            document.getElementById('environmentSelect').value = 'production';

            const actionsEditor = document.getElementById('actionsEditor');
            actionsEditor.style.display = 'block';
            renderActionsEditor();
            updateRetryScript();

            document.getElementById('retryModal').classList.add('active');
        }

        function toggleHistory(workflowId) {
            const history = document.getElementById(`history-${workflowId}`);
            if (history) {
                history.classList.toggle('expanded');
            }
        }

        function showTab(tabName) {
            currentTab = tabName;
            window.location.hash = tabName;

            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            applyFilters();
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderCards();
                document.getElementById('completedGrid').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function applyFilters() {
            if (currentTab === 'completed') {
                currentPage = 1;
                renderCards();
            } else {
                applyFiltersForActiveTab();
            }
        }

        function applyFiltersForActiveTab() {
            const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            const activeTabContent = document.querySelector('.tab-content.active');
            const allCards = activeTabContent ? activeTabContent.querySelectorAll('.workflow-card') : [];

            let visibleCount = 0;
            let totalCount = 0;
            let cardsToSort = [];

            allCards.forEach(card => {
                totalCount++;
                const appName = card.dataset.app || '';
                const workflowId = card.dataset.workflow || '';
                const ticket = card.dataset.ticket || '';
                const state = card.dataset.state || '';
                const passed = parseInt(card.dataset.passed || '0');
                const total = parseInt(card.dataset.total || '0');
                const failed = parseInt(card.dataset.failed || '0');
                const completedTime = card.dataset.completed || '';
                const passRate = total > 0 ? (passed / total) : 0;

                let matchesSearch = searchTerm === '' ||
                    appName.includes(searchTerm) ||
                    workflowId.includes(searchTerm) ||
                    ticket.includes(searchTerm);

                let matchesStatus = true;
                if (statusFilter === 'success') {
                    matchesStatus = state.includes('success') || (total > 0 && passed === total && failed === 0);
                } else if (statusFilter === 'failed') {
                    matchesStatus = state.includes('failed') || state.includes('timed_out') || state.includes('aborted');
                } else if (statusFilter === 'auth_issue') {
                    matchesStatus = state.includes('auth');
                } else if (statusFilter === 'has_failures') {
                    matchesStatus = failed > 0;
                } else if (statusFilter === 'perfect') {
                    matchesStatus = total > 0 && passed === total;
                }

                if (matchesSearch && matchesStatus) {
                    card.style.display = '';
                    visibleCount++;
                    cardsToSort.push({ card, passed, total, passRate, completedTime });
                } else {
                    card.style.display = 'none';
                }
            });

            if (cardsToSort.length > 1) {
                const grid = activeTabContent?.querySelector('.workflow-grid');
                if (grid) {
                    cardsToSort.sort((a, b) => {
                        switch (sortFilter) {
                            case 'time_desc': return b.completedTime.localeCompare(a.completedTime);
                            case 'time_asc': return a.completedTime.localeCompare(b.completedTime);
                            case 'passed_desc': return b.passed - a.passed;
                            case 'passed_asc': return a.passed - b.passed;
                            case 'rate_desc': return b.passRate - a.passRate;
                            case 'rate_asc': return a.passRate - b.passRate;
                            default: return 0;
                        }
                    });
                    cardsToSort.forEach(item => grid.appendChild(item.card));
                }
            }

            const countSpan = document.getElementById('searchCount');
            if (searchTerm || statusFilter !== 'all') {
                countSpan.textContent = `${visibleCount} / ${totalCount}`;
            } else {
                countSpan.textContent = '';
            }
        }

        // Retry Modal Functions
        async function showRetryModal(appName, workflowId, linearTicket, connectionId, environment, runNumber, completeRerun = false) {
            const modalTitle = completeRerun ? `FULL RERUN: ${appName.toUpperCase()}` : `RETRY FAILED: ${appName.toUpperCase()}`;
            document.getElementById('modalAppName').textContent = appName.toUpperCase();
            document.querySelector('.modal-header h2').innerHTML = modalTitle;
            document.getElementById('scriptOutput').innerHTML = '<div class="loading">Loading</div>';
            document.getElementById('appNameInput').value = appName || '';
            document.getElementById('connectionIdInput').value = connectionId || '';
            document.getElementById('linearTicketInput').value = linearTicket || '';

            const normalizedEnv = environment === 'prod' ? 'production' : (environment || 'production');
            document.getElementById('environmentSelect').value = normalizedEnv;

            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = false;
            executeBtn.textContent = 'Execute';
            executeBtn.onclick = executeRetry;

            document.getElementById('retryModal').classList.add('active');

            currentRetryData = {
                app_name: appName,
                workflow_id: workflowId,
                linear_ticket: linearTicket,
                connection_id: connectionId,
                environment: normalizedEnv,
                run_number: runNumber,
                complete_rerun: completeRerun,
                failed_actions: []
            };

            if (completeRerun) {
                renderActionsList();
                updateScriptOutput();
            } else {
                try {
                    const response = await fetch('/api/get-failed-actions.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            workflow_id: workflowId,
                            run_number: runNumber
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const failedActions = data.failed_actions || [];

                    if (!failedActions.length) {
                        document.getElementById('scriptOutput').textContent = 'No failed actions found';
                        return;
                    }

                    currentRetryData.failed_actions = failedActions;
                    renderActionsList();
                    updateScriptOutput();
                } catch (error) {
                    console.error('Error fetching failed actions:', error);
                    document.getElementById('scriptOutput').innerHTML = `<span style="color:var(--accent-pink)">Error: ${error.message}</span>`;
                    return;
                }
            }
        }

        function updateRetryAppName(newAppName) {
            currentRetryData.app_name = newAppName;
            updateScriptOutput();
        }

        function updateRetryConnectionId(newConnectionId) {
            currentRetryData.connection_id = newConnectionId;
            updateScriptOutput();
        }

        function updateRetryLinearTicket(newLinearTicket) {
            currentRetryData.linear_ticket = newLinearTicket;
            updateScriptOutput();
        }

        function updateRetryEnvironment(newEnvironment) {
            currentRetryData.environment = newEnvironment;
            updateScriptOutput();
        }

        function renderActionsList() {
            const editor = document.getElementById('actionsEditor');
            const list = document.getElementById('actionsList');
            const countSpan = document.getElementById('actionsCount');
            const actions = currentRetryData.failed_actions || [];

            if (currentRetryData.complete_rerun) {
                editor.style.display = 'none';
                return;
            }

            editor.style.display = 'block';
            countSpan.textContent = `${actions.length} action${actions.length !== 1 ? 's' : ''}`;

            if (actions.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim); font-size: 11px;">No actions to retry</div>';
                return;
            }

            list.innerHTML = actions.map((action, index) => `
                <div class="action-item">
                    <span class="action-name">${action}</span>
                    <button class="action-remove" onclick="removeAction(${index})">X</button>
                </div>
            `).join('');
        }

        function renderActionsEditor() {
            renderActionsList();
        }

        function removeAction(index) {
            if (currentRetryData.failed_actions && index >= 0 && index < currentRetryData.failed_actions.length) {
                currentRetryData.failed_actions.splice(index, 1);
                renderActionsList();
                updateScriptOutput();
            }
        }

        function updateScriptOutput() {
            const { app_name, workflow_id, linear_ticket, connection_id, environment, failed_actions, complete_rerun } = currentRetryData;

            const normalizedEnv = environment === 'prod' ? 'production' : (environment || 'production');

            const payload = {
                model_provider: 'claude',
                force_run: true,
                timeout_hours: 36,
                previous_workflow_id: workflow_id,
                linear_issue_link: linear_ticket ? `https://linear.app/composio/issue/${linear_ticket}` : '',
                env: normalizedEnv,
                integrator_branch: 'next',
                app_name: app_name,
                base_branch: 'master',
                connection_id: connection_id,
                test_instruction: "Test thoroughly and ensure: (1) tool/parameter descriptions are clear and accurate, (2) correct API endpoints are used, (3) response schemas are complete, (4) the tool is well-built for agent use."
            };

            if (!complete_rerun && failed_actions?.length) {
                payload.action_names = failed_actions;
            }

            const script = `curl -X POST "${INTEGRATOR_API_URL}/workflows/test-and-fix-action/run" \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(payload, null, 2)}'`;

            document.getElementById('scriptOutput').textContent = script;
        }

        function updateRetryScript() {
            updateScriptOutput();
        }

        function closeRetryModal() {
            document.getElementById('retryModal').classList.remove('active');
        }

        function copyScript() {
            const scriptText = document.getElementById('scriptOutput').textContent;
            navigator.clipboard.writeText(scriptText).then(() => {
                const btn = document.querySelector('.modal-btn.secondary:nth-child(2)');
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = original, 1500);
            });
        }

        async function executeRetry() {
            const btn = document.getElementById('executeBtn');
            const scriptOutput = document.getElementById('scriptOutput');
            btn.disabled = true;
            btn.textContent = 'Executing...';

            try {
                const response = await fetch('/api/retry.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentRetryData)
                });
                const data = await response.json();

                if (data.error) {
                    let errorMsg = `ERROR: ${data.error}`;
                    if (data.details) errorMsg += `\n\nDetails: ${data.details}`;
                    if (data.api_response) errorMsg += `\n\nAPI Response: ${JSON.stringify(data.api_response, null, 2)}`;
                    scriptOutput.innerHTML = `<span style="color:var(--accent-pink)">${errorMsg}</span>`;
                    btn.disabled = false;
                    btn.textContent = 'Execute';
                } else {
                    const rerunType = data.complete_rerun ? 'Full Rerun' : 'Failed Retry';
                    scriptOutput.innerHTML = `<span style="color:var(--accent-green)">SUCCESS: ${rerunType}</span>\n\nWorkflow ID: ${data.workflow_id}\nRun Number: ${data.run_number}\nActions: ${data.actions_count}\n\nRefreshing in 2s...`;
                    btn.disabled = true;
                    btn.textContent = 'Success';
                    setTimeout(() => window.location.reload(), 2000);
                }
            } catch (e) {
                scriptOutput.innerHTML = `<span style="color:var(--accent-pink)">ERROR: ${e.message}</span>`;
                btn.disabled = false;
                btn.textContent = 'Execute';
            }
        }

        async function updateMaxConcurrent() {
            const value = parseInt(document.getElementById('maxConcurrent').value);
            if (isNaN(value) || value < 1 || value > 20) {
                alert('Enter a number between 1 and 20');
                return;
            }

            const { error } = await supabaseClient
                .from('config')
                .upsert({ key: 'max_concurrent', value: value });

            if (error) {
                alert('Error: ' + error.message);
            } else {
                const btn = document.querySelector('.config-btn');
                const original = btn.textContent;
                btn.textContent = 'Done!';
                setTimeout(() => btn.textContent = original, 1500);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeRetryModal();
            if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        document.getElementById('retryModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeRetryModal();
        });

        // Initialize
        async function init() {
            try {
                const configResp = await fetch('/api/config.js');
                const config = await configResp.json();
                SUPABASE_URL = config.supabaseUrl;
                SUPABASE_ANON_KEY = config.supabaseAnonKey;

                supabaseClient = window.supabase.createClient(
                    config.supabaseUrl,
                    config.supabaseAnonKey
                );
            } catch (e) {
                console.error('Failed to load config:', e);
                document.body.innerHTML = '<div style="color:var(--accent-pink);padding:60px;text-align:center;font-family:JetBrains Mono,monospace;font-size:14px;text-transform:uppercase;letter-spacing:2px;">Configuration Error</div>';
                return;
            }

            if (currentTab && document.getElementById(currentTab)) {
                showTab(currentTab);
            }
            fetchData();
            fetchFailedTools();
        }

        document.addEventListener('DOMContentLoaded', init);

        setInterval(fetchData, 10000);
        setInterval(fetchFailedTools, 30000);
    </script>
</body>
</html>
